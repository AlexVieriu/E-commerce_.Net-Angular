import{a as pe}from"./chunk-TE3PFEBM.js";import{b as de}from"./chunk-BDS7FPKL.js";import{a as ee}from"./chunk-3LE33VRK.js";import{B as re,G as ne,H as ie,I as oe,J as ae,K as se,R as le,U as ce,Y as me}from"./chunk-VYBFRTFZ.js";import{b as K,d as Q,g as Y,h as Z,l as j,oa as te,qa as C,s as $}from"./chunk-SP5EY7YX.js";import{$b as L,Cc as y,Dc as g,Hb as B,Ib as W,Lc as k,Nb as U,Ob as a,Pb as s,Qb as G,Xb as A,ba as R,bb as u,bc as z,e as m,ea as I,ja as d,nb as F,oa as x,pa as _,pc as l,rc as h,sb as q,tc as J,uc as X,vc as H,x as p,y as E,za as P}from"./chunk-QVMKLVRB.js";var ue="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var fe=(i=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(i|=0));for(;i--;)e+=ue[t[i]&63];return e};var T=class{id=fe();items=[];deliveryMethodId;paymentIntentId;clientSecret;coupon};var v=class i{baseUrl=C.apiUrl;http=d(j);cart=P(null);itemCount=k(()=>this.cart()?.items.reduce((e,t)=>e+t.quantity,0));selectedDelivery=P(null);couponCode=P(null);totals=k(()=>{let e=this.cart(),t=this.selectedDelivery();if(!e)return null;let r=e.items.reduce((c,f)=>c+f.price*f.quantity,0),n=0;e.coupon&&(e.coupon.amountOff?n=e.coupon.amountOff:e.coupon.percentOff&&(n=r*(e.coupon.percentOff/100)));let o=t?t.price:0;return{subtotal:r,shipping:o,discount:n,total:r+o-n}});getCartAsync(e){return this.http.get(this.baseUrl+"cart?id="+e).pipe(E(t=>(this.cart.set(t),t)))}setCart(e){return this.http.post(this.baseUrl+"cart",e).pipe(R(t=>{this.cart.set(t)}))}removeItemFromCart(e,t=1){return m(this,null,function*(){let r=this.cart();if(!r)return;let n=r.items.findIndex(o=>o.productId===e);n!=-1&&(r.items[n].quantity>t?r.items[n].quantity-=t:r.items.splice(n,1),r.items.length===0?this.deleteCart():yield p(this.setCart(r)))})}deleteCart(){this.http.delete(this.baseUrl+"cart?id="+this.cart()?.id).subscribe({next:()=>{localStorage.removeItem("cart_id"),this.cart.set(null)}})}addItemToCart(e,t=1){return m(this,null,function*(){let r=this.cart()??this.createCart();this.isProduct(e)&&(e=this.mapProductToCartItem(e)),r.items=this.addOrUpdateItem(r.items,e,t),yield p(this.setCart(r))})}applyDiscount(e){return this.http.get(this.baseUrl+"coupons/"+e)}addOrUpdateItem(e,t,r){let n=e.findIndex(o=>o.productId===t.productId);return n===-1?(t.quantity=r,e.push(t)):e[n].quantity+=r,e}createCart(){let e=new T;return localStorage.setItem("cart_id",e.id),e}isProduct(e){return e.id!==void 0}mapProductToCartItem(e){return{productId:e.id,productName:e.name,pictureUrl:e.pictureUrl,quantity:0,brand:e.brand,type:e.type,price:e.price}}static \u0275fac=function(t){return new(t||i)};static \u0275prov=I({token:i,factory:i.\u0275fac,providedIn:"root"})};var ye="basil",Ie=function(e){return e===3?"v3":e},ge="https://js.stripe.com",xe="".concat(ge,"/").concat(ye,"/stripe.js"),_e=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,Pe=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,ve="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",Ue=function(e){return _e.test(e)||Pe.test(e)},je=function(){for(var e=document.querySelectorAll('script[src^="'.concat(ge,'"]')),t=0;t<e.length;t++){var r=e[t];if(Ue(r.src))return r}return null},Se=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",r=document.createElement("script");r.src="".concat(xe).concat(t);var n=document.head||document.body;if(!n)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return n.appendChild(r),r},Te=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"7.8.0",startTime:t})},w=null,M=null,V=null,Me=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}},Ve=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},Oe=function(e){return w!==null?w:(w=new Promise(function(t,r){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe&&e&&console.warn(ve),window.Stripe){t(window.Stripe);return}try{var n=je();if(n&&e)console.warn(ve);else if(!n)n=Se(e);else if(n&&V!==null&&M!==null){var o;n.removeEventListener("load",V),n.removeEventListener("error",M),(o=n.parentNode)===null||o===void 0||o.removeChild(n),n=Se(e)}V=Ve(t,r),M=Me(r),n.addEventListener("load",V),n.addEventListener("error",M)}catch(c){r(c);return}}),w.catch(function(t){return w=null,Promise.reject(t)}))},Ae=function(e,t,r){if(e===null)return null;var n=t[0],o=n.match(/^pk_test/),c=Ie(e.version),f=ye;o&&c!==f&&console.warn("Stripe.js@".concat(c," was loaded on the page, but @stripe/stripe-js@").concat("7.8.0"," expected Stripe.js@").concat(f,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var S=e.apply(void 0,t);return Te(S,r),S},b,Ce=!1,we=function(){return b||(b=Oe(null).catch(function(e){return b=null,Promise.reject(e)}),b)};Promise.resolve().then(function(){return we()}).catch(function(i){Ce||console.warn(i)});var be=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];Ce=!0;var n=Date.now();return we().then(function(o){return Ae(o,t,n)})};var O=class i{baseUrl=C.apiUrl;cartService=d(v);accountService=d(de);http=d(j);stripePromise;elements;addressElement;paymentElement;constructor(){this.stripePromise=be(C.stripePublicKey)}getStripeInstance(){return this.stripePromise}initializeElements(){return m(this,null,function*(){if(!this.elements){let e=yield this.getStripeInstance();if(e){let t=yield p(this.createOrUpdatePaymentIntent());this.elements=e.elements({clientSecret:t.clientSecret,appearance:{labels:"floating"}})}else throw new Error("Stripe has not been loaded")}return this.elements})}createPaymentElement(){return m(this,null,function*(){if(!this.paymentElement){let e=yield this.initializeElements();if(e)this.paymentElement=e.create("payment");else throw new Error("Elements instance has not been initialized")}return this.paymentElement})}createAddressElement(){return m(this,null,function*(){if(!this.addressElement){let e=yield this.initializeElements();if(e){let t=this.accountService.currentUser(),r={};t&&(r.name=t.firstName+" "+t.lastName),t?.address&&(r.address={line1:t.address.line1,line2:t.address.line2,city:t.address.city,state:t.address.state,country:t.address.country,postal_code:t.address.postalCode});let n={mode:"shipping",defaultValues:r};this.addressElement=e.create("address",n)}else throw new Error("Elements instance has not been loaded")}return this.addressElement})}createToken(){return m(this,null,function*(){let e=yield this.getStripeInstance(),t=yield this.initializeElements(),r=yield t.submit();if(r.error)throw new Error(r.error.message);if(e)return yield e.createConfirmationToken({elements:t});throw new Error("Stripe not available")})}confirmPayment(e){return m(this,null,function*(){let t=yield this.getStripeInstance(),n=yield(yield this.initializeElements()).submit(),o=this.cartService.cart()?.clientSecret;if(n.error)throw new Error(n.error.message);if(t&&o)return yield t.confirmPayment({clientSecret:o,confirmParams:{confirmation_token:e.id},redirect:"if_required"});throw new Error("Unable to load Stripe")})}createOrUpdatePaymentIntent(){let e=this.cartService.cart(),t=!!e?.clientSecret;if(!e)throw new Error("Problem with cart");return this.http.post(this.baseUrl+"payments/"+e.id,{}).pipe(E(r=>m(this,null,function*(){return t||(yield p(this.cartService.setCart(r))),r})))}disposeElements(){this.elements=void 0,this.addressElement=void 0,this.paymentElement=void 0}static \u0275fac=function(t){return new(t||i)};static \u0275prov=I({token:i,factory:i.\u0275fac,providedIn:"root"})};function Le(i,e){i&1&&(a(0,"div",11)(1,"button",19),l(2,"Checkout"),s(),a(3,"button",20),l(4,"Continue Shopping"),s()())}function ke(i,e){if(i&1){let t=A();a(0,"div",21)(1,"span",22),l(2),s(),a(3,"button",23),L("click",function(){x(t);let n=z();return _(n.removeCouponCode())}),a(4,"mat-icon",24),l(5,"delete"),s()()()}if(i&2){let t=e.ngIf;u(2),h("",t.name," applied")}}var Ee=class i{cartService=d(v);location=d(K);stripeService=d(O);couponCode;applyCouponCode(){this.couponCode&&this.cartService.applyDiscount(this.couponCode).subscribe({next:e=>m(this,null,function*(){let t=this.cartService.cart();t&&(t.coupon=e,yield p(this.cartService.setCart(t)),this.couponCode=void 0,this.location.path()==="/checkout"&&(yield p(this.stripeService.createOrUpdatePaymentIntent())))})})}removeCouponCode(){return m(this,null,function*(){let e=this.cartService.cart();e&&(e.coupon&&(e.coupon=void 0),yield p(this.cartService.setCart(e)),this.location.path()==="/checkout"&&(yield p(this.stripeService.createOrUpdatePaymentIntent())))})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=F({type:i,selectors:[["app-order-summary"]],decls:44,vars:17,consts:[["form","ngForm"],[1,"mx-auto","max-w-4xl","flex-1","space-y-6","w-full"],[1,"space-y-4","rounded-lg","border","border-gray-200","bg-white","shadow-sm","p-5"],[1,"text-xl","font-semibold"],[1,"space-y-4"],[1,"space-y-2"],[1,"flex","items-center","justify-between","gap-4"],[1,"font-medium","text-gray-500"],[1,"font-medium","text-gray-900"],[1,"font-medium","text-green-500"],[1,"flex","items-center","justify-between","gap-4","border-t","border-gray-200","pt-2"],[1,"flex","flex-col","gap-2"],[1,"space-y-4","rounded-lg","border","border-gray-200","bg-white","shadow-sm"],[1,"space-y-2","flex","flex-col","p-2",3,"ngSubmit"],[1,"mb-2","block","text-sm","font-mediem"],["class","flex justify-between items-center",4,"ngIf"],["appearance","outline"],["name","code","type","text","matInput","",3,"ngModelChange","disabled","ngModel"],["type","submit","mat-flat-button","",3,"disabled"],["routerLink","/checkout","mat-flat-button",""],["routerLink","/shop","mat-button",""],[1,"flex","justify-between","items-center"],[1,"text-sm","font-semibold"],["mat-icon-button","",3,"click"],["color","warn"]],template:function(t,r){if(t&1){let n=A();a(0,"div",1)(1,"div",2)(2,"p",3),l(3,"Order summary"),s(),a(4,"div",4)(5,"div",5)(6,"dl",6)(7,"dt",7),l(8,"Subtotal"),s(),a(9,"dd",8),l(10),y(11,"currency"),s()(),a(12,"dl",6)(13,"dt",7),l(14,"Discount"),s(),a(15,"dd",9),l(16),y(17,"currency"),s()(),a(18,"dl",6)(19,"dt",7),l(20,"Shipping fee "),s(),G(21,"dt"),a(22,"dd",8),l(23),y(24,"currency"),s()()(),a(25,"dl",10)(26,"dt",7),l(27,"Total"),s(),a(28,"dd",8),l(29),y(30,"currency"),s()()(),B(31,Le,5,0,"div",11),s(),a(32,"div",12)(33,"form",13,0),L("ngSubmit",function(){return x(n),_(r.applyCouponCode())}),a(35,"label",14),l(36," Do you have a voucher code? "),s(),q(37,ke,6,1,"div",15),a(38,"mat-form-field",16)(39,"mat-label"),l(40,"Voucher code"),s(),a(41,"input",17),H("ngModelChange",function(c){return x(n),X(r.couponCode,c)||(r.couponCode=c),_(c)}),s()(),a(42,"button",18),l(43,"Apply code"),s()()()()}if(t&2){let n,o,c,f,S,D,N;u(10),h(" ",g(11,9,(n=r.cartService.totals())==null?null:n.subtotal)," "),u(6),h(" ",g(17,11,(o=r.cartService.totals())==null?null:o.discount)," "),u(7),h(" ",g(24,13,(c=r.cartService.totals())==null?null:c.shipping)," "),u(6),h(" ",g(30,15,(f=r.cartService.totals())==null?null:f.total)," "),u(2),W(r.location.path()!=="/checkout"?31:-1),u(6),U("ngIf",(S=r.cartService.cart())==null?null:S.coupon),u(4),U("disabled",!!((D=r.cartService.cart())!=null&&D.coupon)),J("ngModel",r.couponCode),u(),U("disabled",!!((N=r.cartService.cart())!=null&&N.coupon))}},dependencies:[te,$,me,ce,pe,le,se,re,ne,ie,ae,oe,Z,Q,ee,Y],encapsulation:2})};export{v as a,O as b,Ee as c};
